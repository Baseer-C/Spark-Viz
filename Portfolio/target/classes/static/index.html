<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cluster Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f0f14;
      --surface: #1a1a24;
      --surface-hover: #222230;
      --border: #2a2a3a;
      --text: #e8e8ed;
      --muted: #8888a0;
      --pending: #6b7280;
      --running: #3b82f6;
      --completed: #22c55e;
      --failed: #ef4444;
      --kill: #dc2626;
      --kill-hover: #b91c1c;
      --accent: #6366f1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1.5rem;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
    .status {
      color: var(--muted);
      font-size: 0.875rem;
    }
    .status.connected { color: var(--completed); }
    .status.disconnected { color: var(--failed); }

    .cluster-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
    }
    .stat-card.highlight {
      border-color: var(--completed);
      background: linear-gradient(135deg, rgba(34,197,94,0.08) 0%, var(--surface) 100%);
    }
    .stat-label {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
    }
    .stat-card.highlight .stat-value { color: var(--completed); }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }
    .legend-dot.PENDING { background: var(--pending); }
    .legend-dot.RUNNING { background: var(--running); }
    .legend-dot.COMPLETED { background: var(--completed); }
    .legend-dot.FAILED { background: var(--failed); }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      max-width: 1400px;
    }
    .worker-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      min-height: 320px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .worker-card:hover { border-color: var(--accent); }
    .worker-card.killed {
      opacity: 0.5;
      pointer-events: none;
    }
    .worker-card.just-completed {
      animation: pulse-green 0.6s ease-out;
    }
    @keyframes pulse-green {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
      70% { box-shadow: 0 0 0 12px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }
    .worker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }
    .worker-name { font-weight: 600; font-size: 1.05rem; }
    .worker-health {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      background: rgba(34,197,94,0.2);
      color: var(--completed);
    }
    .worker-health.UNHEALTHY { background: rgba(239,68,68,0.2); color: var(--failed); }

    .worker-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .worker-metric {
      background: var(--bg);
      border-radius: 8px;
      padding: 0.6rem 0.75rem;
      text-align: center;
    }
    .worker-metric .value { font-size: 1.25rem; font-weight: 700; display: block; }
    .worker-metric .label { font-size: 0.7rem; color: var(--muted); }
    .worker-metric.completed .value { color: var(--completed); }
    .worker-metric.slots .value { color: var(--accent); }

    .tasks-section { margin-bottom: 0.5rem; }
    .tasks-section-title { font-size: 0.7rem; color: var(--muted); margin-bottom: 0.4rem; }
    .tasks-box {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-content: flex-start;
      min-height: 88px;
    }
    .task-dot {
      width: 22px;
      height: 22px;
      border-radius: 4px;
      flex-shrink: 0;
      transition: transform 0.15s;
    }
    .task-dot:hover { transform: scale(1.1); }
    .task-dot.PENDING { background: var(--pending); }
    .task-dot.RUNNING { background: var(--running); box-shadow: 0 0 8px rgba(59,130,246,0.5); }
    .task-dot.COMPLETED { background: var(--completed); }
    .task-dot.FAILED { background: var(--failed); }
    .kill-btn {
      margin-top: auto;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      font-weight: 600;
      color: white;
      background: var(--kill);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .kill-btn:hover { background: var(--kill-hover); }
    .kill-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .run-job-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      max-width: 1400px;
    }
    .run-job-section h2 {
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .run-job-form {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 1rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .form-group label {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .form-group input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-size: 0.95rem;
      width: 100%;
      min-width: 80px;
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-group-checkbox {
      justify-content: flex-end;
    }
    .form-group-checkbox .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      text-transform: none;
      letter-spacing: 0;
    }
    .form-group-checkbox input[type="checkbox"] {
      width: auto;
      min-width: 0;
      accent-color: var(--accent);
    }
    .form-hint {
      font-size: 0.7rem;
      color: var(--muted);
      display: block;
      margin-top: 0.2rem;
    }
    .run-job-btn {
      padding: 0.6rem 1.25rem;
      font-size: 0.95rem;
      font-weight: 600;
      color: white;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .run-job-btn:hover { background: #5558e3; }
    .run-job-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .run-job-msg {
      font-size: 0.85rem;
      margin-top: 0.5rem;
      min-height: 1.2em;
    }
    .run-job-msg.success { color: var(--completed); }
    .run-job-msg.error { color: var(--failed); }

    .dag-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      margin-top: 1.5rem;
      max-width: 1400px;
    }
    .dag-section h2 {
      margin: 0 0 0.75rem 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--muted);
    }
    .dag-diagram {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      min-height: 60px;
    }
    .dag-stage {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .dag-node {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 0.85rem;
      font-size: 0.8rem;
      text-align: center;
      min-width: 80px;
    }
    .dag-node.pending { border-color: var(--pending); color: var(--muted); }
    .dag-node.running { border-color: var(--running); background: rgba(59,130,246,0.15); color: var(--text); }
    .dag-node.completed { border-color: var(--completed); background: rgba(34,197,94,0.12); color: var(--completed); }
    .dag-node .dag-node-title { font-weight: 600; display: block; }
    .dag-node .dag-node-count { font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem; }
    .dag-arrow {
      color: var(--muted);
      font-size: 1rem;
      flex-shrink: 0;
    }
    .dag-empty {
      color: var(--muted);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>Cluster Dashboard</h1>
      <p id="status" class="status disconnected">Connecting...</p>
    </div>
  </div>

  <div class="cluster-summary" id="clusterSummary">
    <div class="stat-card highlight">
      <div class="stat-label">Total completed</div>
      <div class="stat-value" id="totalCompleted">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Tasks scheduled</div>
      <div class="stat-value" id="totalScheduled">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Pending</div>
      <div class="stat-value" id="pendingCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Running now</div>
      <div class="stat-value" id="runningTasks">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Jobs</div>
      <div class="stat-value" id="totalJobs">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Slots (free / total)</div>
      <div class="stat-value" id="slots">0 / 0</div>
    </div>
  </div>

  <div class="legend">
    <span class="legend-item"><span class="legend-dot PENDING"></span> Pending / idle slot</span>
    <span class="legend-item"><span class="legend-dot RUNNING"></span> Running</span>
    <span class="legend-item"><span class="legend-dot COMPLETED"></span> Completed</span>
    <span class="legend-item"><span class="legend-dot FAILED"></span> Failed</span>
  </div>

  <div class="run-job-section">
    <h2>Run new job</h2>
    <form class="run-job-form" id="runJobForm">
      <div class="form-group">
        <label for="jobDesc">Description</label>
        <input type="text" id="jobDesc" placeholder="My job" value="">
      </div>
      <div class="form-group">
        <label for="stageCount">Stages</label>
        <input type="number" id="stageCount" min="1" max="20" value="3">
      </div>
      <div class="form-group">
        <label for="tasksPerStage">Tasks per stage</label>
        <input type="number" id="tasksPerStage" min="1" max="32" value="4">
      </div>
      <div class="form-group">
        <label for="taskDurationMs">Task duration (ms)</label>
        <input type="number" id="taskDurationMs" min="100" max="30000" value="1000">
      </div>
      <div class="form-group form-group-checkbox">
        <label class="checkbox-label">
          <input type="checkbox" id="simulateDataSkew" name="simulateDataSkew">
          <span>Simulate Data Skew</span>
        </label>
        <span class="form-hint">One random task in Stage 2 runs 10s (straggler)</span>
      </div>
      <button type="submit" class="run-job-btn" id="runJobBtn">Run job</button>
    </form>
    <p id="runJobMsg" class="run-job-msg"></p>
  </div>

  <div class="grid" id="workerGrid"></div>

  <div class="dag-section">
    <h2>Job DAG</h2>
    <div class="dag-diagram" id="dagDiagram"></div>
  </div>

  <script>
    const baseUrl = (window.location.origin && window.location.origin.startsWith('http'))
      ? window.location.origin
      : 'http://localhost:8080';
    const apiBase = baseUrl + '/api/workers';
    const jobsApiBase = baseUrl + '/api/jobs';

    const statusEl = document.getElementById('status');
    const workerGrid = document.getElementById('workerGrid');
    const totalCompletedEl = document.getElementById('totalCompleted');
    const totalScheduledEl = document.getElementById('totalScheduled');
    const pendingCountEl = document.getElementById('pendingCount');
    const runningTasksEl = document.getElementById('runningTasks');
    const totalJobsEl = document.getElementById('totalJobs');
    const slotsEl = document.getElementById('slots');
    const dagDiagramEl = document.getElementById('dagDiagram');
    const runJobMsgEl = document.getElementById('runJobMsg');

    let previousCompletedByWorker = {};

    const client = new StompJs.Client({
      brokerURL: baseUrl.replace(/^http/, 'ws'),
      reconnectDelay: 2000,
      heartbeatIncoming: 4000,
      heartbeatOutgoing: 4000,
    });
    client.webSocketFactory = function () { return new SockJS(baseUrl + '/ws'); };

    client.onConnect = function () {
      statusEl.textContent = 'Connected · live updates every 500ms';
      statusEl.className = 'status connected';
      client.subscribe('/topic/cluster-state', function (msg) {
        const state = JSON.parse(msg.body);
        render(state);
      });
    };
    client.onStompError = function () {
      statusEl.textContent = 'Disconnected. Retrying...';
      statusEl.className = 'status disconnected';
    };
    client.activate();

    function render(state) {
      totalCompletedEl.textContent = state.totalTasksCompleted ?? 0;
      totalScheduledEl.textContent = state.totalTasksScheduled ?? 0;
      pendingCountEl.textContent = state.pendingTaskCount ?? 0;
      runningTasksEl.textContent = state.runningTasks ?? 0;
      totalJobsEl.textContent = state.totalJobs ?? 0;
      slotsEl.textContent = (state.availableSlots ?? 0) + ' / ' + (state.totalSlots ?? 0);

      const workers = state.workers || [];
      workerGrid.innerHTML = '';

      renderDag(state.dag);

      for (let i = 0; i < 4; i++) {
        const worker = workers[i];
        const card = document.createElement('div');
        card.className = 'worker-card';
        const workerId = worker ? worker.id : null;
        const completed = worker ? worker.totalTasksExecuted : 0;
        const prevCompleted = previousCompletedByWorker[workerId] ?? 0;
        if (workerId && completed > prevCompleted) {
          card.classList.add('just-completed');
          previousCompletedByWorker[workerId] = completed;
        }
        if (workerId) previousCompletedByWorker[workerId] = completed;

        if (!worker) {
          card.classList.add('killed');
          card.innerHTML = `
            <div class="worker-header"><span class="worker-name">Worker ${i + 1}</span></div>
            <div class="worker-metrics">
              <div class="worker-metric completed"><span class="value">—</span><span class="label">Completed</span></div>
              <div class="worker-metric slots"><span class="value">—</span><span class="label">Slots</span></div>
            </div>
            <div class="tasks-section"><div class="tasks-section-title">Slots</div><div class="tasks-box"></div></div>
            <button class="kill-btn" disabled>KILL NODE</button>
          `;
        } else {
          const tasks = worker.tasks || [];
          const taskDots = tasks.map(t =>
            `<div class="task-dot ${t.status}" title="${(t.description || t.id).replace(/"/g, '&quot;')}"></div>`
          ).join('');
          card.innerHTML = `
            <div class="worker-header">
              <span class="worker-name">${worker.hostname}</span>
              <span class="worker-health ${worker.health}">${worker.health}</span>
            </div>
            <div class="worker-metrics">
              <div class="worker-metric completed"><span class="value">${worker.totalTasksExecuted}</span><span class="label">Tasks completed</span></div>
              <div class="worker-metric slots"><span class="value">${worker.availableSlots}/${worker.totalSlots}</span><span class="label">Slots free</span></div>
            </div>
            <div class="tasks-section">
              <div class="tasks-section-title">Current slots (running = blue, idle = gray)</div>
              <div class="tasks-box">${taskDots}</div>
            </div>
            <button class="kill-btn" data-worker-id="${worker.id}">KILL NODE</button>
          `;
          card.querySelector('.kill-btn').addEventListener('click', function () {
            killWorker(worker.id, this);
          });
        }
        workerGrid.appendChild(card);
      }
    }

    function killWorker(workerId, btn) {
      if (btn.disabled) return;
      btn.disabled = true;
      btn.textContent = 'Killing...';
      fetch(apiBase + '/' + encodeURIComponent(workerId) + '/kill', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(function (res) {
          if (res.ok) btn.textContent = 'Killed';
          else { btn.disabled = false; btn.textContent = 'KILL NODE'; }
        })
        .catch(function () { btn.disabled = false; btn.textContent = 'KILL NODE'; });
    }

    function renderDag(dag) {
      if (!dagDiagramEl) return;
      if (!dag || !dag.stages || dag.stages.length === 0) {
        dagDiagramEl.innerHTML = '<span class="dag-empty">No job data yet. Run a job to see the DAG.</span>';
        return;
      }
      const stages = dag.stages;
      let html = '';
      for (let i = 0; i < stages.length; i++) {
        const s = stages[i];
        const state = s.completed ? 'completed' : (i === 0 || (i > 0 && stages[i - 1].completed) ? 'running' : 'pending');
        html += '<div class="dag-stage">';
        html += '<div class="dag-node ' + state + '">';
        html += '<span class="dag-node-title">' + escapeHtml(s.description || ('Stage ' + (i + 1))) + '</span>';
        html += '<span class="dag-node-count">' + s.completedCount + ' / ' + s.taskCount + '</span>';
        html += '</div>';
        if (i < stages.length - 1) {
          html += '<span class="dag-arrow">→</span>';
        }
        html += '</div>';
      }
      dagDiagramEl.innerHTML = html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.getElementById('runJobForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const desc = document.getElementById('jobDesc').value.trim();
      const stageCount = Math.max(1, parseInt(document.getElementById('stageCount').value, 10) || 3);
      const tasksPerStage = Math.max(1, parseInt(document.getElementById('tasksPerStage').value, 10) || 4);
      const taskDurationMs = Math.max(100, parseInt(document.getElementById('taskDurationMs').value, 10) || 1000);
      const stages = [];
      for (let i = 0; i < stageCount; i++) {
        stages.push({ taskCount: tasksPerStage, taskDurationMs: taskDurationMs });
      }
      const simulateDataSkew = document.getElementById('simulateDataSkew').checked;
      const btn = document.getElementById('runJobBtn');
      runJobMsgEl.textContent = '';
      runJobMsgEl.className = 'run-job-msg';
      btn.disabled = true;
      fetch(jobsApiBase + '/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: desc || undefined, stages: stages, simulateDataSkew: simulateDataSkew })
      })
        .then(function (res) {
          return res.json().then(function (data) {
            if (res.ok && data.success) {
              runJobMsgEl.textContent = 'Job submitted: ' + (data.description || data.jobId);
              runJobMsgEl.className = 'run-job-msg success';
            } else {
              runJobMsgEl.textContent = data.message || 'Submit failed';
              runJobMsgEl.className = 'run-job-msg error';
            }
          });
        })
        .catch(function () {
          runJobMsgEl.textContent = 'Network error';
          runJobMsgEl.className = 'run-job-msg error';
        })
        .finally(function () {
          btn.disabled = false;
        });
    });
  </script>
</body>
</html>
